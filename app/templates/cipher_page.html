<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Шифратор - {{ method_name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui'],
            },
            colors: {
              primary: '#FFD600',
              accent: '#FFF9C4',
              dark: '#181818',
              border: '#333',
            }
          }
        }
      }
    </script>
</head>
<body class="bg-dark text-primary min-h-screen flex items-center justify-center font-sans">
    <div class="relative bg-dark border border-border p-8 rounded-xl w-full max-w-xl shadow-lg">
        <a href="/" class="absolute top-4 left-4 text-primary hover:text-accent transition duration-150 ease-in-out" title="Назад">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        <h1 class="text-2xl font-semibold mb-6 text-center tracking-tight">Шифратор: <span id="cipher-method-display" class="capitalize">{{ method_name }}</span></h1>
        <input type="hidden" id="method" value="{{ method_value }}">

        <label class="block mb-2 text-accent">Введите текст:</label>
        <textarea id="text" class="w-full p-2 rounded bg-dark border border-border text-accent mb-4 focus:outline-none focus:ring-2 focus:ring-primary transition" rows="5"></textarea>

        <div id="param-container" class="mb-4">
            <label class="block mb-2 text-accent">Сдвиг / Ключ:</label>
            <input id="param" type="text" class="w-full p-2 rounded bg-dark border border-border text-accent focus:outline-none focus:ring-2 focus:ring-primary transition">
        </div>

        <label class="inline-flex items-center mb-4 select-none">
            <input type="checkbox" id="decrypt" class="form-checkbox h-5 w-5 text-primary mr-2 focus:ring-primary">
            <span class="text-accent">Дешифровка</span>
        </label>

        <div class="flex flex-wrap gap-2 mb-4">
            <label class="flex items-center cursor-pointer border border-primary text-primary font-medium py-2 px-4 rounded bg-transparent hover:bg-primary hover:text-dark transition">
                <input type="file" id="fileInput" class="hidden" onchange="openFile(event)">
                Открыть файл
            </label>
            <button onclick="saveResult()" class="border border-primary text-primary font-medium py-2 px-4 rounded bg-transparent hover:bg-primary hover:text-dark transition">
                Сохранить результат
            </button>
            <button onclick="showHistory()" class="border border-primary text-primary font-medium py-2 px-4 rounded bg-transparent hover:bg-primary hover:text-dark transition">
                История
            </button>
        </div>

        <button onclick="submitCipher()" class="bg-primary text-dark font-semibold py-2 px-4 rounded w-full mb-4 hover:bg-accent transition">
            Запустить
        </button>

        <h2 class="text-lg font-semibold mb-2 text-accent">Результат:</h2>
        <pre id="result" class="bg-dark border border-border p-4 rounded text-sm text-accent whitespace-pre-wrap max-h-64 overflow-y-auto"></pre>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-dark border border-border rounded-lg p-6 w-full max-w-xl relative">
            <button onclick="closeHistory()" class="absolute top-2 right-2 text-accent hover:text-primary text-2xl">&times;</button>
            <h3 class="text-base font-semibold mb-4 text-accent">История шифрования</h3>
            <pre id="historyContent" class="bg-dark border border-border p-4 rounded text-sm text-accent max-h-96 overflow-y-auto"></pre>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const method = document.getElementById('method').value;
        const paramContainer = document.getElementById('param-container');
        const paramLabel = paramContainer.querySelector('label');

        if (method === 'atbash') {
            paramContainer.style.display = 'none';
        } else {
            paramContainer.style.display = 'block';
            if (method === 'caesar') {
                paramLabel.textContent = 'Сдвиг:';
            } else if (method === 'vigenere' || method === 'xor') {
                paramLabel.textContent = 'Ключ:';
            } else {
                paramLabel.textContent = 'Параметр:';
            }
        }
    });

    function openFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('file', file);
        fetch('/open_file', {method: 'POST', body: formData})
            .then(r => r.json())
            .then(data => {
                if (data.content) document.getElementById('text').value = data.content;
                else alert(data.error || 'Ошибка при открытии файла');
            });
    }
    function saveResult() {
        const result = document.getElementById('result').textContent;
        if (!result.trim()) { alert('Нет текста для сохранения.'); return; }
        const filename = prompt('Введите имя файла для сохранения:', 'result.txt') || 'result.txt';
        fetch('/save_result', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({result, filename})
        })
        .then(r => r.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        });
    }
    function showHistory() {
        fetch('/history')
            .then(r => r.json())
            .then(data => {
                document.getElementById('historyContent').textContent = data.log || 'Лог пуст.';
                document.getElementById('historyModal').classList.remove('hidden');
            });
    }
    function closeHistory() {
        document.getElementById('historyModal').classList.add('hidden');
    }
    </script>
</body>
</html>